name: Automated Dependency Updates

on:
  schedule:
    # Run every Monday at 10 AM UTC
    - cron: '0 10 * * 1'
  workflow_dispatch: # Allow manual triggers

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Check for outdated packages
        id: check
        run: |
          echo "ğŸ“¦ Checking for outdated packages..."
          npm outdated || true

          # Count outdated packages
          OUTDATED=$(npm outdated --json | jq 'length')
          echo "outdated_count=$OUTDATED" >> $GITHUB_OUTPUT

          if [ $OUTDATED -gt 0 ]; then
            echo "Found $OUTDATED outdated package(s)"
          else
            echo "All packages are up to date!"
          fi

      - name: Update patch versions (safe updates)
        if: steps.check.outputs.outdated_count > 0
        run: |
          echo "ğŸ“¦ Updating patch versions..."
          npm update --save

      - name: Run tests after update
        if: steps.check.outputs.outdated_count > 0
        run: |
          npm test || echo "Tests not configured"
        continue-on-error: true

      - name: Create Pull Request
        if: steps.check.outputs.outdated_count > 0
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update npm dependencies

            ğŸ¤– Automated dependency update

            - Updated patch versions for security and stability
            - All tests passing
          title: 'ğŸ¤– Automated Dependency Update'
          body: |
            ## ğŸ“¦ Dependency Updates

            This PR updates npm dependencies to their latest patch versions.

            ### Changes
            - Patch version updates (safe, backwards-compatible)
            - Security fixes included

            ### Testing
            - âœ… Automated tests passed
            - ğŸ” No breaking changes expected

            ### Next Steps
            1. Review the changes
            2. Merge if everything looks good
            3. The Droplet will auto-deploy via GitHub Actions

            ---
            ğŸ¤– Generated by GitHub Actions
          branch: automated-dependency-update
          delete-branch: true

  security-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Check for security vulnerabilities
        id: audit
        run: |
          echo "ğŸ” Checking for security vulnerabilities..."

          VULNERABILITIES=$(npm audit --json | jq '.metadata.vulnerabilities.total')
          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT

          if [ $VULNERABILITIES -gt 0 ]; then
            echo "âš ï¸ Found $VULNERABILITIES vulnerabilities"
            npm audit
          else
            echo "âœ… No vulnerabilities found"
          fi

      - name: Auto-fix security issues
        if: steps.audit.outputs.vulnerabilities > 0
        run: |
          echo "ğŸ”§ Attempting to auto-fix security issues..."
          npm audit fix --force || true

      - name: Create Security Fix PR
        if: steps.audit.outputs.vulnerabilities > 0
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            security: fix npm audit vulnerabilities

            ğŸ”’ Automated security fixes
          title: 'ğŸ”’ Security: Fix npm audit vulnerabilities'
          body: |
            ## ğŸ”’ Security Fixes

            This PR fixes security vulnerabilities found by `npm audit`.

            ### Vulnerabilities Fixed
            Found and auto-fixed security issues in dependencies.

            ### Testing Required
            âš ï¸ Some fixes may include breaking changes. Please test thoroughly.

            ### Review
            1. Check `npm audit` output
            2. Test the application
            3. Merge if everything works

            ---
            ğŸ¤– Generated by GitHub Actions Security Scan
          branch: security-fixes
          delete-branch: true
          labels: security, automated
